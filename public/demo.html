<!DOCTYPE html>
<html lang="hr">
  <head>
    <meta charset="UTF-8" />
    <title>Chat narud≈æbe proizvoda</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #f4f4f5;
        margin: 0;
        padding: 0;
      }
      .page {
        max-width: 900px;
        margin: 0 auto;
        padding: 16px;
      }
      .card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
        margin-bottom: 16px;
      }
      .chat-window {
        border-radius: 12px;
        border: 1px solid #e4e4e7;
        background: #ffffff;
        height: 550px;
        display: flex;
        flex-direction: column;
      }
      .chat-messages {
        flex: 1;
        padding: 12px;
        overflow-y: auto;
      }
      .msg {
        margin-bottom: 10px;
        max-width: 85%;
      }
      .msg-user {
        text-align: right;
        margin-left: auto;
      }
      .msg-assistant {
        text-align: left;
        margin-right: auto;
      }
      .bubble {
        display: inline-block;
        padding: 8px 12px;
        border-radius: 999px;
      }
      .bubble-user {
        background: #f97316;
        color: white;
        border-bottom-right-radius: 4px;
      }
      .bubble-assistant {
        background: #e4e4e7;
        color: #111827;
        border-bottom-left-radius: 4px;
      }
      .chat-input {
        border-top: 1px solid #e4e4e7;
        padding: 8px;
        display: flex;
        gap: 8px;
      }
      .chat-input textarea {
        flex: 1;
        resize: none;
        border-radius: 999px;
        border: 1px solid #d4d4d8;
        padding: 8px 12px;
        font-family: inherit;
        font-size: 0.95rem;
        min-height: 38px;
        max-height: 80px;
      }
      .chat-input button {
        border-radius: 999px;
        border: none;
        padding: 0 18px;
        background: #f97316;
        color: white;
        font-weight: 600;
        cursor: pointer;
      }
      .chat-input button:disabled {
        opacity: 0.5;
        cursor: default;
      }
      .lang-switch {
        display: flex;
        gap: 6px;
        justify-content: flex-end;
        margin-bottom: 8px;
      }
      .lang-btn {
        border-radius: 999px;
        border: 1px solid #d4d4d8;
        padding: 3px 10px;
        font-size: 0.8rem;
        background: #f4f4f5;
        cursor: pointer;
      }
      .lang-btn.is-active {
        background: #f97316;
        border-color: #f97316;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="lang-switch">
        <button class="lang-btn is-active" data-lang="hr">HR</button>
        <button class="lang-btn" data-lang="de">DE</button>
        <button class="lang-btn" data-lang="en">EN</button>
      </div>

      <div class="card">
        <h1 id="hero-title">Rezerviraj svoje proizvode putem chata ü§ñ</h1>
        <p id="hero-lead">
          Naruƒçi proizvode iz kataloga putem jednostavnog chat asistenta. Bez
          aplikacije, bez registracije ‚Äî samo po≈°alji poruku kao na WhatsAppu.
        </p>
      </div>

      <div class="card">
        <h2 id="chat-title">Chat narud≈æba</h2>
        <p id="chat-lead">
          Upi≈°ite svoju narud≈æbu ‚Äî bot ƒáe vas voditi kroz cijeli proces.
        </p>

        <div class="chat-window">
          <div id="chat-messages" class="chat-messages"></div>
          <div class="chat-input">
            <textarea
              id="chat-input"
              rows="1"
              placeholder="Napi≈°ite poruku..."
            ></textarea>
            <button id="chat-send">Po≈°alji</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        let currentLang = (params.get("lang") || "hr").toLowerCase();
        if (currentLang.startsWith("de")) currentLang = "de";
        else if (currentLang.startsWith("en")) currentLang = "en";
        else currentLang = "hr";

        const messagesEl = document.getElementById("chat-messages");
        const inputEl = document.getElementById("chat-input");
        const sendBtn = document.getElementById("chat-send");
        const langButtons = document.querySelectorAll(".lang-btn");

        const heroTitle = document.getElementById("hero-title");
        const heroLead = document.getElementById("hero-lead");
        const chatTitle = document.getElementById("chat-title");
        const chatLead = document.getElementById("chat-lead");

        const texts = {
          hr: {
            heroTitle: "Rezerviraj svoje proizvode putem chata ü§ñ",
            heroLead:
              "Naruƒçi proizvode iz kataloga putem jednostavnog chat asistenta. Bez aplikacije, bez registracije ‚Äî samo po≈°alji poruku kao na WhatsAppu.",
            chatTitle: "Chat narud≈æba",
            chatLead:
              "Upi≈°ite svoju narud≈æbu ‚Äî bot ƒáe vas voditi kroz cijeli proces.",
            placeholder: "Napi≈°ite poruku...",
            send: "Po≈°alji",
            intro:
              "Dobrodo≈°li! Napi≈°ite koju robu ≈æelite naruƒçiti (proizvod, broj komada, vrijeme preuzimanja)."
          },
          de: {
            heroTitle: "Bestellen Sie Ihre Produkte per Chat ü§ñ",
            heroLead:
              "Bestellen Sie Produkte aus dem Katalog √ºber einen einfachen Chat-Assistenten. Keine App, keine Registrierung ‚Äì schreiben Sie einfach wie bei WhatsApp.",
            chatTitle: "Chat-Bestellung",
            chatLead:
              "Geben Sie Ihre Bestellung ein ‚Äì der Bot f√ºhrt Sie durch den gesamten Ablauf.",
            placeholder: "Nachricht eingeben...",
            send: "Senden",
            intro:
              "Willkommen! Schreiben Sie, welche Produkte Sie bestellen m√∂chten (Produkt, Anzahl, Abholzeit)."
          },
          en: {
            heroTitle: "Order your products via chat ü§ñ",
            heroLead:
              "Order products from the catalogue using a simple chat assistant. No app, no registration ‚Äì just send a message like on WhatsApp.",
            chatTitle: "Chat order",
            chatLead:
              "Type your order ‚Äî the bot will guide you through the whole process.",
            placeholder: "Type a message...",
            send: "Send",
            intro:
              "Welcome! Tell me which products you want to order (product, quantity, pickup time)."
          }
        };

        let history = [];
        let turnCount = 0; // broj korisniƒçkih poruka u ovom chatu
        let totalChars = 0; // ukupna koliƒçina znakova u razgovoru
const MAX_MESSAGE_CHARS = 300;    // max 300 znakova u jednoj poruci
const MAX_TOTAL_CHARS = 3000;     // max 3000 znakova u cijelom chatu


        function renderTexts() {
          const t = texts[currentLang];
          heroTitle.textContent = t.heroTitle;
          heroLead.textContent = t.heroLead;
          chatTitle.textContent = t.chatTitle;
          chatLead.textContent = t.chatLead;
          inputEl.placeholder = t.placeholder;
          sendBtn.textContent = t.send;

          langButtons.forEach((btn) => {
            btn.classList.toggle(
              "is-active",
              btn.getAttribute("data-lang") === currentLang
            );
          });
        }

        function addMessage(role, content) {
          const wrapper = document.createElement("div");
          wrapper.className =
            "msg " + (role === "user" ? "msg-user" : "msg-assistant");
          const bubble = document.createElement("div");
          bubble.className =
            "bubble " +
            (role === "user" ? "bubble-user" : "bubble-assistant");
          bubble.textContent = content;
          wrapper.appendChild(bubble);
          messagesEl.appendChild(wrapper);
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        async function sendMessage() {
          const text = inputEl.value.trim();
          if (!text) return;
            // LIMIT JEDNE PORUKE (predugaƒçka)
  if (text.length > MAX_MESSAGE_CHARS) {
    addMessage(
      "assistant",
      "Va≈°a poruka je predugaƒçka. Maksimalna duljina je " +
        MAX_MESSAGE_CHARS +
        " znakova. Molim vas po≈°aljite kraƒáu poruku."
    );
      inputEl.disabled = true;
  sendBtn.disabled = true;
  return;

  }

  // LIMIT UKUPNIH ZNAKOVA U RAZGOVORU
  if (totalChars + text.length > MAX_TOTAL_CHARS) {
    addMessage(
      "assistant",
      "Dosegnuta je maksimalna duljina razgovora. " +
        "Molim vas osvje≈æite stranicu i zapoƒçnite novu narud≈æbu."
    );

    inputEl.disabled = true;
    sendBtn.disabled = true;

    return;
  }

  // ako je sve u granicama ‚Üí zbroji znakove
  totalChars += text.length;


          // LIMIT 20 PORUKA ‚Äî nakon toga chat je zakljuƒçan
          if (turnCount >= 20) {
            addMessage(
              "assistant",
              "Dosegnut je maksimalan broj poruka za ovu narud≈æbu. Molim vas osvje≈æite stranicu ako ≈æelite zapoƒçeti novi razgovor."
            );

            inputEl.disabled = true;
            sendBtn.disabled = true;

            return;
          }

          addMessage("user", text);
          history.push({ role: "user", content: text });
          history = history.slice(-20);
          turnCount++; // brojimo korisniƒçke poruke

          inputEl.value = "";
          inputEl.disabled = true;
          sendBtn.disabled = true;

          try {
            const resp = await fetch("/api/chat", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                projectId: "burek01",
                lang: currentLang,
                messages: history
              })
            });

            const data = await resp.json();
            const reply = data.reply || "";
            addMessage(
              "assistant",
              reply.replace(/JSON_ORDER:.*/s, "").trim()
            );
            history.push({ role: "assistant", content: reply });
            history = history.slice(-20);
          } catch (e) {
            console.error(e);
            addMessage(
              "assistant",
              "Do≈°lo je do gre≈°ke. Poku≈°ajte ponovo za nekoliko trenutaka."
            );
          } finally {
            // ponovno omoguƒái tipkanje SAMO ako jo≈° nismo pre≈°li limit
            if (turnCount < 20) {
              inputEl.disabled = false;
              sendBtn.disabled = false;
              inputEl.focus();
            }
          }
        }

        sendBtn.addEventListener("click", sendMessage);
        inputEl.addEventListener("keydown", function (e) {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
          }
        });

        langButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            const lang = btn.getAttribute("data-lang");
            currentLang = lang;
            renderTexts();

            const url = new URL(window.location.href);
            url.searchParams.set("lang", lang);
            window.history.replaceState({}, "", url.toString());
          });
        });

        renderTexts();

        // inicijalna poruka ‚Äì generiƒçki proizvodi, bez bureka
        const intro = texts[currentLang].intro;
        addMessage("assistant", intro);
        history.push({
          role: "assistant",
          content: intro
        });
      })();
    </script>
  </body>
</html>
